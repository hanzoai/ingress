apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: hanzo-ingress
  namespace: hanzo
  labels:
    app: hanzo-ingress
    app.kubernetes.io/name: hanzo-ingress
    app.kubernetes.io/part-of: hanzo-universe
spec:
  selector:
    matchLabels:
      app: hanzo-ingress
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: hanzo-ingress
    spec:
      serviceAccountName: hanzo-ingress
      imagePullSecrets:
      - name: ghcr-secret
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: ingress
        image: ghcr.io/hanzoai/ingress:latest
        imagePullPolicy: Always
        args:
        # Providers
        - "--providers.kubernetesingress=true"
        - "--providers.kubernetesingress.allowemptyservices=true"
        - "--providers.kubernetesingress.allowexternalnameservices=true"
        - "--providers.kubernetescrd=true"
        - "--providers.kubernetescrd.allowcrossnamespace=true"
        - "--providers.kubernetescrd.allowexternalnameservices=true"
        - "--providers.kubernetescrd.allowemptyservices=true"
        # Entrypoints
        - "--entrypoints.web.address=:80"
        - "--entrypoints.web.http.redirections.entrypoint.to=:443"
        - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
        - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
        - "--entrypoints.websecure.address=:443"
        - "--entrypoints.websecure.http.tls=true"
        - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
        # ACME / Let's Encrypt via Cloudflare DNS-01
        - "--certificatesresolvers.letsencrypt.acme.email=dev@hanzo.ai"
        - "--certificatesresolvers.letsencrypt.acme.storage=/data/acme.json"
        - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
        - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
        - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
        # Health + observability
        - "--ping=true"
        - "--ping.entryPoint=web"
        - "--api.dashboard=false"
        - "--log.level=INFO"
        - "--accesslog=true"
        - "--accesslog.fields.defaultmode=keep"
        - "--accesslog.fields.headers.defaultmode=drop"
        env:
        - name: CF_API_EMAIL
          valueFrom:
            secretKeyRef:
              name: cloudflare-api-credentials
              key: email
        - name: CF_API_KEY
          valueFrom:
            secretKeyRef:
              name: cloudflare-api-credentials
              key: apiKey
        ports:
        - name: web
          containerPort: 80
          hostPort: 80
        - name: websecure
          containerPort: 443
          hostPort: 443
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          httpGet:
            path: /ping
            port: 80
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ping
            port: 80
            scheme: HTTP
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: "2"
            memory: 512Mi
        securityContext:
          capabilities:
            add: ["NET_BIND_SERVICE"]
            drop: ["ALL"]
      volumes:
      - name: data
        hostPath:
          path: /var/lib/hanzo-ingress
          type: DirectoryOrCreate
